<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schedule</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 1em;
        }
        h2 {
            text-align: center;
        }
        .employee-list {
            margin: 1em 0;
            text-align: center;
        }
        .employee-list button {
            margin: 0.5em;
            padding: 0.5em 1em;
            cursor: grab;
            background-color: #f0f0f0;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        .schedule-container {
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        table, th, td {
            border: 1px solid #ccc;
        }
        th, td {
            padding: 0.5em;
            text-align: center;
        }
        .highlighted {
            background-color: #ffeeba;
        }
        .drop-target {
            background-color: #e9e9e9;
            position: relative;
        }
        .drop-target.over {
            background-color: #d3d3f3;
        }
        .station-name {
            cursor: pointer;
            font-weight: bold;
        }
        .assigned-employee {
            cursor: pointer;
            font-weight: normal;
            color: inherit;
            text-decoration: none;
        }
    </style>
</head>
<body>
    <div class="employee-list" id="employee-list">
        <!-- Employee buttons will be dynamically added here -->
    </div>

    <div class="schedule-container">
        <table>
            <thead>
                <tr>
                    <th>Group</th>
                    <th>Station / Hour</th>
                    <th>8:00 - 9:00</th>
                    <th>9:00 - 10:00</th>
                    <th>10:00 - 11:00</th>
                    <th>11:00 - 12:00</th>
                    <th>12:00 - 13:00</th>
                    <th>13:00 - 14:00</th>
                    <th>14:00 - 15:00</th>
                    <th>15:00 - 16:00</th>
                    <th>16:00 - 17:00</th>
                    <th>17:00 - 18:00</th>
                    <th>18:00 - 19:00</th>
                    <th>19:00 - 20:00</th>
                </tr>
            </thead>
            <tbody id="schedule-table">
                <!-- Schedule rows will be dynamically added here -->
            </tbody>
        </table>
    </div>

    <div style="text-align: center; margin-top: 1em;">
        <button id="reset-schedule">Reset Schedule</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-database.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDUO5c-1RSGpGspdAStcGmrEVb0qD0FbnU",
            authDomain: "emsd-cef45.firebaseapp.com",
            databaseURL: "https://emsd-cef45-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "emsd-cef45",
            storageBucket: "emsd-cef45.appspot.com",
            messagingSenderId: "573007211940",
            appId: "1:573007211940:web:651a9d8785eb14a0ea2531"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        const employeeList = document.getElementById('employee-list');
        const scheduleTable = document.getElementById('schedule-table');
        const resetScheduleButton = document.getElementById('reset-schedule');

        let stationsData = {};
        let scheduleData = {};
        let employeesData = {};

        function loadAllData() {
            const stationsRef = ref(database, 'stations');
            const scheduleRef = ref(database, 'schedule');
            const employeesRef = ref(database, 'employees');

            onValue(stationsRef, (snapshot) => {
                stationsData = snapshot.val() || {};
                renderScheduleTable();
            });

            onValue(scheduleRef, (snapshot) => {
                scheduleData = snapshot.val() || {};
                renderScheduleTable();
            });

            onValue(employeesRef, (snapshot) => {
                employeesData = snapshot.val() || {};
                renderEmployeeList();
                renderScheduleTable();
            });
        }

        function renderEmployeeList() {
            employeeList.innerHTML = '';
            Object.values(employeesData).forEach(employee => {
                if (employee.available) {
                    const button = document.createElement('button');
                    button.textContent = employee.name;
                    button.draggable = true;
                    button.addEventListener('dragstart', (e) => {
                        e.dataTransfer.setData('text/plain', JSON.stringify({
                            name: employee.name
                        }));
                    });
                    employeeList.appendChild(button);
                }
            });
        }

        function renderScheduleTable() {
            scheduleTable.innerHTML = '';

            Object.keys(stationsData).forEach(stationId => {
                const station = stationsData[stationId];
                const row = document.createElement('tr');
                row.innerHTML = `<td>${station.group || ''}</td><td class="station-name" data-station="${station.name}">${station.name}</td>` +
                    new Array(12).fill(0).map((_, index) => {
                        const hour = index + 8;
                        const employees = (scheduleData[hour] && scheduleData[hour][station.name]?.employees) || [];
                        return `<td class="drop-target" data-station="${station.name}" data-hour="${hour}">` +
                            employees.map(emp => `<span class="assigned-employee" data-employee="${emp}">${emp}</span>`).join(', ') +
                            `</td>`;
                    }).join('');
                scheduleTable.appendChild(row);
            });

            enableDragAndDrop();
            enableStationAssignment();
            enableEmployeeRemoval();
        }

        function enableDragAndDrop() {
            const dropTargets = document.querySelectorAll('.drop-target');

            dropTargets.forEach(cell => {
                cell.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    cell.classList.add('over');
                });

                cell.addEventListener('dragleave', () => {
                    cell.classList.remove('over');
                });

                cell.addEventListener('drop', (e) => {
                    e.preventDefault();
                    const { name: employeeName } = JSON.parse(e.dataTransfer.getData('text/plain'));
                    const stationName = cell.getAttribute('data-station');
                    const hour = cell.getAttribute('data-hour');

                    assignEmployeeToStation(employeeName, stationName, hour);
                });
            });
        }

        function enableStationAssignment() {
            const stationNames = document.querySelectorAll('.station-name');

            stationNames.forEach(stationCell => {
                stationCell.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    stationCell.classList.add('highlighted');
                });

                stationCell.addEventListener('dragleave', () => {
                    stationCell.classList.remove('highlighted');
                });

                stationCell.addEventListener('drop', (e) => {
                    e.preventDefault();
                    const { name: employeeName } = JSON.parse(e.dataTransfer.getData('text/plain'));
                    const stationName = stationCell.getAttribute('data-station');

                    for (let hour = 8; hour <= 19; hour++) {
                        assignEmployeeToStation(employeeName, stationName, hour);
                    }
                });
            });
        }

        function enableEmployeeRemoval() {
            const assignedEmployees = document.querySelectorAll('.assigned-employee');

            assignedEmployees.forEach(employeeSpan => {
                employeeSpan.addEventListener('click', () => {
                    const employeeName = employeeSpan.getAttribute('data-employee');
                    const cell = employeeSpan.closest('.drop-target');
                    const stationName = cell.getAttribute('data-station');
                    const hour = cell.getAttribute('data-hour');

                    scheduleData[hour][stationName].employees = scheduleData[hour][stationName].employees.filter(emp => emp !== employeeName);

                    set(ref(database, `schedule/${hour}/${stationName}`), scheduleData[hour][stationName])
                        .then(() => {
                            renderEmployeeList();
                            renderScheduleTable();
                        });
                });
            });
        }

        function assignEmployeeToStation(employeeName, stationName, hour) {
            if (!scheduleData[hour]) {
                scheduleData[hour] = {};
            }

            if (!scheduleData[hour][stationName]) {
                scheduleData[hour][stationName] = { employees: [] };
            }

            const stationLimit = stationsData[stationName]?.limit || Infinity;
            if (scheduleData[hour][stationName].employees.length >= stationLimit) {
                alert(`Station ${stationName} has reached its limit of ${stationLimit} employees.`);
                return;
            }

            scheduleData[hour][stationName].employees.push(employeeName);

            set(ref(database, `schedule/${hour}/${stationName}`), scheduleData[hour][stationName])
                .then(() => {
                    renderEmployeeList();
                    renderScheduleTable();
                });
        }

        resetScheduleButton.addEventListener('click', () => {
            scheduleData = {};
            set(ref(database, 'schedule'), {}).then(() => {
                renderEmployeeList();
                renderScheduleTable();
            });
        });

        loadAllData();
    </script>
</body>
</html>
